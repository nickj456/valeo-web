<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Valeo – Championship</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #111826;
      --panel-2: #0f1623;
      --text: #e6eef8;
      --muted: #9bb0c7;
      --border: #223046;
      --accent: #7dd3fc;
      --good: #34d399;
      --warn: #fbbf24;
      --bad: #fb7185;
      --chip: #172235;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      display: flex;
      gap: 12px;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    h1 { margin: 0; font-size: 18px; font-weight: 650; }
    .sub { color: var(--muted); font-size: 13px; }

    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .card {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }

    .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
    }

    .card-title {
      font-size: 14px;
      font-weight: 650;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .chip {
      font-size: 12px;
      color: var(--muted);
      background: var(--chip);
      border: 1px solid var(--border);
      padding: 3px 8px;
      border-radius: 999px;
    }

    .actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    button {
      cursor: pointer;
      border: 1px solid var(--border);
      background: #0c1420;
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
    }
    button:hover { border-color: #35507a; }

    .table-wrap {
      overflow: auto;
      max-height: 520px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12.5px;
      min-width: 980px;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #0f1726;
      border-bottom: 1px solid var(--border);
      color: var(--muted);
      text-align: left;
      padding: 10px 10px;
      white-space: nowrap;
    }

    tbody td {
      border-bottom: 1px solid rgba(34,48,70,0.65);
      padding: 9px 10px;
      vertical-align: middle;
      white-space: nowrap;
    }

    tbody tr:hover td {
      background: rgba(125, 211, 252, 0.06);
    }

    .num { text-align: right; font-variant-numeric: tabular-nums; }
    .mono { font-variant-numeric: tabular-nums; }
    .muted { color: var(--muted); }
    .good { color: var(--good); }
    .warn { color: var(--warn); }
    .bad { color: var(--bad); }

    .pill {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      padding: 3px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(23, 34, 53, 0.6);
    }

    .suggest {
      outline: 2px solid rgba(52, 211, 153, 0.55);
      outline-offset: -2px;
      border-radius: 8px;
    }

    /* tooltips */
    .th-tip {
      border-bottom: 1px dotted rgba(155,176,199,0.55);
      cursor: help;
    }

    .err {
      padding: 12px 14px;
      color: #fecaca;
      background: rgba(248, 113, 113, 0.08);
      border-top: 1px solid rgba(248, 113, 113, 0.25);
      font-size: 12px;
    }

    .note {
      padding: 10px 14px;
      color: var(--muted);
      font-size: 12px;
      border-top: 1px solid var(--border);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Valeo – Championship</h1>
        <div class="sub" id="status">Loading…</div>
      </div>
      <div class="actions">
        <button id="refreshBtn">Refresh</button>
      </div>
    </header>

    <div class="row">
      <section class="card">
        <div class="card-head">
          <div class="card-title">
            Value picks (O/U 2.5)
            <span class="chip" id="picksCount">0</span>
          </div>
          <div class="actions">
            <span class="muted" id="picksMeta"></span>
          </div>
        </div>
        <div class="table-wrap">
          <table id="picksTable">
            <thead>
              <tr>
                <th>Kickoff</th>
                <th>Match</th>
                <th class="th-tip" title="Your suggested bet based on EV and filters">Pick</th>
                <th class="num th-tip" title="Best price found from your odds feed">Odds</th>
                <th class="th-tip" title="Bookmaker for the best price">Book</th>
                <th class="num th-tip" title="Final probability used for EV (model blended with market)">Model</th>
                <th class="num th-tip" title="Fair market probability after margin removal">Market</th>
                <th class="num th-tip" title="Expected value per £1 stake: (p*odds - 1)">EV</th>
                <th class="num th-tip" title="Model vs market absolute difference">Δ</th>
                <th class="num th-tip" title="Model expected total goals (xG_home + xG_away)">xG total</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="note" id="picksNote">If you see 0 picks, that’s normal on tight filters + limited odds coverage.</div>
      </section>

      <section class="card">
        <div class="card-head">
          <div class="card-title">
            All next-round totals (probabilities)
            <span class="chip" id="totalsCount">0</span>
          </div>
          <div class="actions">
            <span class="muted" id="totalsMeta"></span>
          </div>
        </div>
        <div class="table-wrap">
          <table id="totalsTable">
            <thead>
              <tr>
                <th>Kickoff</th>
                <th>Match</th>
                <th class="num th-tip" title="Expected total goals (xG_home + xG_away)">xG total</th>
                <th class="num th-tip" title="Probability total goals under 1.5">U1.5</th>
                <th class="num th-tip" title="Probability total goals under 2.5">U2.5</th>
                <th class="num th-tip" title="Probability total goals over 2.5">O2.5</th>
                <th class="num th-tip" title="Probability total goals over 3.5">O3.5</th>
                <th class="th-tip" title="Suggested side based on which is higher: U2.5 vs O2.5">Suggested</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="note">This table should always show fixtures, even when no “value picks” fire.</div>
      </section>
    </div>
  </div>

  <script>
    const PICKS_URL = "/champ_ou25_edge_report.json";
    const TOTALS_URL = "/champ_totals_predictions.json";

    const elStatus = document.getElementById("status");
    const picksTableBody = document.querySelector("#picksTable tbody");
    const totalsTableBody = document.querySelector("#totalsTable tbody");
    const picksCount = document.getElementById("picksCount");
    const totalsCount = document.getElementById("totalsCount");
    const picksMeta = document.getElementById("picksMeta");
    const totalsMeta = document.getElementById("totalsMeta");
    const refreshBtn = document.getElementById("refreshBtn");

    function fmtPct(x) {
      if (x === null || x === undefined || Number.isNaN(Number(x))) return "";
      return (Number(x) * 100).toFixed(1) + "%";
    }

    function fmtNum(x, dp=2) {
      if (x === null || x === undefined || Number.isNaN(Number(x))) return "";
      return Number(x).toFixed(dp);
    }

    function fmtDate(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString(undefined, { weekday: "short", month: "short", day: "2-digit", hour: "2-digit", minute: "2-digit" });
      } catch {
        return iso;
      }
    }

    // Heatmap: shade cell background based on probability 0..1
    function heatBg(prob) {
      const p = Math.max(0, Math.min(1, Number(prob)));
      const a = 0.10 + p * 0.30; // opacity
      // teal-ish
      return `rgba(125, 211, 252, ${a})`;
    }

    function evClass(ev) {
      const v = Number(ev);
      if (v >= 0.10) return "good";
      if (v >= 0.03) return "warn";
      if (v < 0) return "bad";
      return "";
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`${url} -> ${res.status}`);
      return res.json();
    }

    function clearTables() {
      picksTableBody.innerHTML = "";
      totalsTableBody.innerHTML = "";
    }

    function renderPicks(rows) {
      picksCount.textContent = rows.length;
      if (!rows.length) {
        picksMeta.textContent = "No picks in current window";
        return;
      }

      picksMeta.textContent = `Showing top ${rows.length}`;

      for (const r of rows) {
        const tr = document.createElement("tr");

        const xgTotal = (Number(r.xg_home) || 0) + (Number(r.xg_away) || 0);

        tr.innerHTML = `
          <td class="mono">${fmtDate(r.utc_date)}</td>
          <td>${r.home} vs ${r.away}</td>
          <td><span class="pill">${r.pick || ""}</span></td>
          <td class="num mono">${fmtNum(r.odds, 2)}</td>
          <td class="muted">${r.bookmaker || ""}</td>
          <td class="num mono" style="background:${heatBg(r.model_p)}">${fmtPct(r.model_p)}</td>
          <td class="num mono" style="background:${heatBg(r.market_p)}">${fmtPct(r.market_p)}</td>
          <td class="num mono ${evClass(r.ev)}">${(Number(r.ev) >= 0 ? "+" : "")}${fmtNum(r.ev, 3)}</td>
          <td class="num mono">${fmtNum(r.disagree, 3)}</td>
          <td class="num mono">${fmtNum(xgTotal, 2)}</td>
        `;
        picksTableBody.appendChild(tr);
      }
    }

    function renderTotals(rows) {
      totalsCount.textContent = rows.length;
      if (!rows.length) {
        totalsMeta.textContent = "No fixtures loaded";
        return;
      }
      totalsMeta.textContent = `Showing ${rows.length} fixtures`;

      for (const r of rows) {
        const tr = document.createElement("tr");
        const u25 = Number(r.p_under_2_5);
        const o25 = Number(r.p_over_2_5);
        const suggested = (u25 >= o25) ? "UNDER 2.5" : "OVER 2.5";

        tr.innerHTML = `
          <td class="mono">${fmtDate(r.utc_date)}</td>
          <td>${r.home} vs ${r.away}</td>
          <td class="num mono">${fmtNum(r.xg_total, 2)}</td>
          <td class="num mono" style="background:${heatBg(r.p_under_1_5)}">${fmtPct(r.p_under_1_5)}</td>
          <td class="num mono ${u25 >= o25 ? "suggest" : ""}" style="background:${heatBg(r.p_under_2_5)}">${fmtPct(r.p_under_2_5)}</td>
          <td class="num mono ${o25 > u25 ? "suggest" : ""}" style="background:${heatBg(r.p_over_2_5)}">${fmtPct(r.p_over_2_5)}</td>
          <td class="num mono" style="background:${heatBg(r.p_over_3_5)}">${fmtPct(r.p_over_3_5)}</td>
          <td><span class="pill">${suggested}</span></td>
        `;
        totalsTableBody.appendChild(tr);
      }
    }

    async function load() {
      clearTables();
      elStatus.textContent = "Loading…";

      try {
        const [picks, totals] = await Promise.all([
          fetchJson(PICKS_URL),
          fetchJson(TOTALS_URL),
        ]);

        renderPicks(Array.isArray(picks) ? picks : []);
        renderTotals(Array.isArray(totals) ? totals : []);

        const now = new Date();
        elStatus.textContent = `Updated ${now.toLocaleString()} • Sources: ${PICKS_URL}, ${TOTALS_URL}`;
      } catch (err) {
        console.error(err);
        elStatus.textContent = "Failed to load data. Check console.";
        picksCount.textContent = "0";
        totalsCount.textContent = "0";
        picksMeta.textContent = "";
        totalsMeta.textContent = "";

        const card1 = document.querySelectorAll(".card")[0];
        const div = document.createElement("div");
        div.className = "err";
        div.textContent = String(err);
        card1.appendChild(div);
      }
    }

    refreshBtn.addEventListener("click", load);
    load();
  </script>
</body>
</html>
