<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Valeo – Championship</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #111826;
      --panel-2: #0f1623;
      --text: #e6eef8;
      --muted: #9bb0c7;
      --border: #223046;
      --accent: #7dd3fc;
      --good: #34d399;
      --warn: #fbbf24;
      --bad: #fb7185;
      --chip: #172235;
      --shadow: rgba(0,0,0,0.35);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      display: flex;
      gap: 12px;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    h1 { margin: 0; font-size: 18px; font-weight: 650; }
    .sub { color: var(--muted); font-size: 13px; }

    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .card {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }

    .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      gap: 10px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 650;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .chip {
      font-size: 12px;
      color: var(--muted);
      background: var(--chip);
      border: 1px solid var(--border);
      padding: 3px 8px;
      border-radius: 999px;
    }

    .actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    button {
      cursor: pointer;
      border: 1px solid var(--border);
      background: #0c1420;
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
    }
    button:hover { border-color: #35507a; }

    .table-wrap {
      overflow: auto;
      max-height: 520px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12.5px;
      min-width: 1080px;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #0f1726;
      border-bottom: 1px solid var(--border);
      color: var(--muted);
      text-align: left;
      padding: 10px 10px;
      white-space: nowrap;
    }

    tbody td {
      border-bottom: 1px solid rgba(34,48,70,0.65);
      padding: 9px 10px;
      vertical-align: middle;
      white-space: nowrap;
    }

    tbody tr:hover td {
      background: rgba(125, 211, 252, 0.06);
    }

    tbody tr.clickable {
      cursor: pointer;
    }

    .num { text-align: right; font-variant-numeric: tabular-nums; }
    .mono { font-variant-numeric: tabular-nums; }
    .muted { color: var(--muted); }
    .good { color: var(--good); }
    .warn { color: var(--warn); }
    .bad { color: var(--bad); }

    .pill {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      padding: 3px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(23, 34, 53, 0.6);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      background: rgba(23, 34, 53, 0.6);
      color: var(--muted);
    }

    .badgeA { color: #7dfcc8; border-color: rgba(52,211,153,0.35); }
    .badgeB { color: #fcd57d; border-color: rgba(251,191,36,0.35); }
    .badgeC { color: #fca5a5; border-color: rgba(251,113,133,0.35); }

    .suggestCell {
      outline: 2px solid rgba(52, 211, 153, 0.55);
      outline-offset: -2px;
      border-radius: 8px;
    }

    /* tooltips */
    .th-tip {
      border-bottom: 1px dotted rgba(155,176,199,0.55);
      cursor: help;
    }

    .err {
      padding: 12px 14px;
      color: #fecaca;
      background: rgba(248, 113, 113, 0.08);
      border-top: 1px solid rgba(248, 113, 113, 0.25);
      font-size: 12px;
    }

    .note {
      padding: 10px 14px;
      color: var(--muted);
      font-size: 12px;
      border-top: 1px solid var(--border);
    }

    /* Drawer */
    .drawerOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      z-index: 50;
    }
    .drawerOverlay.open { display: block; }

    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: min(520px, 92vw);
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border-left: 1px solid var(--border);
      box-shadow: -12px 0 24px var(--shadow);
      transform: translateX(100%);
      transition: transform 160ms ease;
      z-index: 60;
      display: flex;
      flex-direction: column;
    }
    .drawer.open { transform: translateX(0); }

    .drawerHead {
      padding: 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .drawerTitle {
      font-size: 14px;
      font-weight: 650;
      line-height: 1.25;
    }
    .drawerSub {
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
    }
    .drawerClose {
      border: 1px solid var(--border);
      background: #0c1420;
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .drawerClose:hover { border-color: #35507a; }

    .drawerBody {
      padding: 14px;
      overflow: auto;
      display: grid;
      gap: 12px;
    }

    .kv {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px 10px;
      padding: 10px 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(23, 34, 53, 0.35);
      font-size: 12.5px;
    }
    .kv div:nth-child(2n) { text-align: right; font-variant-numeric: tabular-nums; }
    .kv .k { color: var(--muted); }
    .kv .v { color: var(--text); }

    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 560px) {
      .split { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Valeo – Championship</h1>
        <div class="sub" id="status">Loading…</div>
      </div>
      <div class="actions">
        <button id="refreshBtn">Refresh</button>
      </div>
    </header>

    <div class="row">
      <section class="card">
        <div class="card-head">
          <div class="card-title">
            Value picks (O/U 2.5)
            <span class="chip" id="picksCount">0</span>
          </div>
          <div class="actions">
            <span class="muted" id="picksMeta"></span>
          </div>
        </div>
        <div class="table-wrap">
          <table id="picksTable">
            <thead>
              <tr>
                <th>Kickoff</th>
                <th>Match</th>
                <th class="th-tip" title="Suggested based on EV and filters">Pick</th>
                <th class="num th-tip" title="Best price found from your odds feed">Odds</th>
                <th class="th-tip" title="Best-price source label (may be blank)">Book</th>
                <th class="num th-tip" title="Final probability used for EV">Model</th>
                <th class="num th-tip" title="Fair market probability after margin removal">Market</th>
                <th class="num th-tip" title="Expected value per £1 stake: (p*odds - 1)">EV</th>
                <th class="num th-tip" title="Model vs market absolute difference">Δ</th>
                <th class="num th-tip" title="Expected total goals (xG_home + xG_away)">xG total</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="note" id="picksNote">0 picks is normal on tight filters + limited odds coverage.</div>
      </section>

      <section class="card">
        <div class="card-head">
          <div class="card-title">
            Upcoming totals + Signal Score
            <span class="chip" id="totalsCount">0</span>
            <span class="badge badgeA th-tip" title="Tier A: score ≥ 70">A</span>
            <span class="badge badgeB th-tip" title="Tier B: score 50–69">B</span>
            <span class="badge badgeC th-tip" title="Tier C: score < 50">C</span>
          </div>
          <div class="actions">
            <span class="muted" id="totalsMeta"></span>
          </div>
        </div>
        <div class="table-wrap">
          <table id="totalsTable">
            <thead>
              <tr>
                <th>Kickoff</th>
                <th>Match</th>
                <th class="num th-tip" title="Signal Score (0–100). Click a row for details.">Score</th>
                <th class="th-tip" title="Tier from score: A≥70, B 50–69, C<50">Tier</th>
                <th class="num th-tip" title="Expected total goals (xG_home + xG_away)">xG total</th>
                <th class="num th-tip" title="Probability total goals under 1.5">U1.5</th>
                <th class="num th-tip" title="Probability total goals under 2.5">U2.5</th>
                <th class="num th-tip" title="Probability total goals over 2.5">O2.5</th>
                <th class="num th-tip" title="Probability total goals over 3.5">O3.5</th>
                <th class="th-tip" title="Model lean from U2.5 vs O2.5">Suggested</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="note">Click a row to see why it scored that way.</div>
      </section>
    </div>
  </div>

  <!-- Drawer -->
  <div class="drawerOverlay" id="drawerOverlay"></div>
  <aside class="drawer" id="drawer">
    <div class="drawerHead">
      <div>
        <div class="drawerTitle" id="drawerTitle">Fixture</div>
        <div class="drawerSub" id="drawerSub">Details</div>
      </div>
      <button class="drawerClose" id="drawerClose">Close</button>
    </div>
    <div class="drawerBody" id="drawerBody"></div>
  </aside>

  <script>
    const PICKS_URL  = "/champ_ou25_edge_report.json";
    const TOTALS_URL = "/champ_totals_predictions.json";
    const SIGNAL_URL = "/champ_signal_report.json";

    const elStatus = document.getElementById("status");
    const picksTableBody = document.querySelector("#picksTable tbody");
    const totalsTableBody = document.querySelector("#totalsTable tbody");
    const picksCount = document.getElementById("picksCount");
    const totalsCount = document.getElementById("totalsCount");
    const picksMeta = document.getElementById("picksMeta");
    const totalsMeta = document.getElementById("totalsMeta");
    const refreshBtn = document.getElementById("refreshBtn");

    const drawer = document.getElementById("drawer");
    const drawerOverlay = document.getElementById("drawerOverlay");
    const drawerClose = document.getElementById("drawerClose");
    const drawerTitle = document.getElementById("drawerTitle");
    const drawerSub = document.getElementById("drawerSub");
    const drawerBody = document.getElementById("drawerBody");

    function fmtPct(x) {
      if (x === null || x === undefined || Number.isNaN(Number(x))) return "";
      return (Number(x) * 100).toFixed(1) + "%";
    }

    function fmtNum(x, dp=2) {
      if (x === null || x === undefined || Number.isNaN(Number(x))) return "";
      return Number(x).toFixed(dp);
    }

    function fmtDate(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString(undefined, { weekday: "short", month: "short", day: "2-digit", hour: "2-digit", minute: "2-digit" });
      } catch {
        return iso;
      }
    }

    // Heatmap 0..1 for probabilities, red->green
    function heatProb(prob) {
      const p = Math.max(0, Math.min(1, Number(prob)));
      const hue = 8 + (p * 120); // 8=red-ish, 128=green-ish
      const alpha = 0.08 + (p * 0.28);
      return `hsla(${hue}, 70%, 45%, ${alpha})`;
    }

    // Heatmap 0..100 for score, red->green
    function heatScore(score) {
      const s = Math.max(0, Math.min(100, Number(score)));
      const p = s / 100;
      const hue = 8 + (p * 120);
      const alpha = 0.10 + (p * 0.30);
      return `hsla(${hue}, 70%, 45%, ${alpha})`;
    }

    function evClass(ev) {
      const v = Number(ev);
      if (v >= 0.10) return "good";
      if (v >= 0.03) return "warn";
      if (v < 0) return "bad";
      return "";
    }

    function tierFromScore(score) {
      const s = Number(score);
      if (!Number.isFinite(s)) return { t: "—", cls: "badge" };
      if (s >= 70) return { t: "A", cls: "badge badgeA" };
      if (s >= 50) return { t: "B", cls: "badge badgeB" };
      return { t: "C", cls: "badge badgeC" };
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`${url} -> ${res.status}`);
      return res.json();
    }

    function clearTables() {
      picksTableBody.innerHTML = "";
      totalsTableBody.innerHTML = "";
    }

    function openDrawer(payload) {
      drawerTitle.textContent = payload.title || "Fixture";
      drawerSub.textContent = payload.sub || "";
      drawerBody.innerHTML = "";

      const blocks = payload.blocks || [];
      for (const b of blocks) {
        const div = document.createElement("div");
        div.className = "kv";
        for (const row of b) {
          const k = document.createElement("div");
          k.className = "k";
          k.textContent = row.k;

          const v = document.createElement("div");
          v.className = "v";
          v.textContent = row.v;

          div.appendChild(k);
          div.appendChild(v);
        }
        drawerBody.appendChild(div);
      }

      drawerOverlay.classList.add("open");
      drawer.classList.add("open");
    }

    function closeDrawer() {
      drawerOverlay.classList.remove("open");
      drawer.classList.remove("open");
    }

    drawerOverlay.addEventListener("click", closeDrawer);
    drawerClose.addEventListener("click", closeDrawer);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeDrawer();
    });

    function renderPicks(rows) {
      picksCount.textContent = rows.length;
      if (!rows.length) {
        picksMeta.textContent = "No picks in current window";
        return;
      }

      picksMeta.textContent = `Showing top ${rows.length}`;

      for (const r of rows) {
        const tr = document.createElement("tr");

        const xgTotal = (Number(r.xg_home) || 0) + (Number(r.xg_away) || 0);

        tr.innerHTML = `
          <td class="mono">${fmtDate(r.utc_date)}</td>
          <td>${r.home} vs ${r.away}</td>
          <td><span class="pill">${r.pick || ""}</span></td>
          <td class="num mono">${fmtNum(r.odds, 2)}</td>
          <td class="muted">${r.bookmaker || ""}</td>
          <td class="num mono" style="background:${heatProb(r.model_p)}">${fmtPct(r.model_p)}</td>
          <td class="num mono" style="background:${heatProb(r.market_p)}">${fmtPct(r.market_p)}</td>
          <td class="num mono ${evClass(r.ev)}">${(Number(r.ev) >= 0 ? "+" : "")}${fmtNum(r.ev, 3)}</td>
          <td class="num mono">${fmtNum(r.disagree, 3)}</td>
          <td class="num mono">${fmtNum(xgTotal, 2)}</td>
        `;
        picksTableBody.appendChild(tr);
      }
    }

    function buildSignalIndex(signalRows) {
      const idx = new Map();
      for (const s of signalRows) {
        idx.set(Number(s.fixture_id), s);
      }
      return idx;
    }

    function renderTotals(totalsRows, signalIndex) {
      totalsCount.textContent = totalsRows.length;
      if (!totalsRows.length) {
        totalsMeta.textContent = "No fixtures loaded";
        return;
      }

      const hasSignals = signalIndex && signalIndex.size > 0;
      totalsMeta.textContent = `Showing ${totalsRows.length} fixtures${hasSignals ? " • click row for details" : ""}`;

      for (const r of totalsRows) {
        const tr = document.createElement("tr");
        tr.classList.add("clickable");

        const u25 = Number(r.p_under_2_5);
        const o25 = Number(r.p_over_2_5);
        const suggested = (u25 >= o25) ? "UNDER 2.5" : "OVER 2.5";

        const sig = signalIndex ? signalIndex.get(Number(r.fixture_id)) : null;
        const score = sig ? Number(sig.signal_score) : null;
        const tier = tierFromScore(score);

        tr.innerHTML = `
          <td class="mono">${fmtDate(r.utc_date)}</td>
          <td>${r.home} vs ${r.away}</td>
          <td class="num mono" style="background:${score === null ? "" : heatScore(score)}">${score === null ? "—" : score}</td>
          <td><span class="${tier.cls}">${tier.t}</span></td>
          <td class="num mono">${fmtNum(r.xg_total, 2)}</td>
          <td class="num mono" style="background:${heatProb(r.p_under_1_5)}">${fmtPct(r.p_under_1_5)}</td>
          <td class="num mono ${u25 >= o25 ? "suggestCell" : ""}" style="background:${heatProb(r.p_under_2_5)}">${fmtPct(r.p_under_2_5)}</td>
          <td class="num mono ${o25 > u25 ? "suggestCell" : ""}" style="background:${heatProb(r.p_over_2_5)}">${fmtPct(r.p_over_2_5)}</td>
          <td class="num mono" style="background:${heatProb(r.p_over_3_5)}">${fmtPct(r.p_over_3_5)}</td>
          <td><span class="pill">${suggested}</span></td>
        `;

        tr.addEventListener("click", () => {
          if (!sig) {
            openDrawer({
              title: `${r.home} vs ${r.away}`,
              sub: `${fmtDate(r.utc_date)} • No signal detail found (champ_signal_report.json missing for this fixture)`,
              blocks: [
                [
                  { k: "xG total", v: fmtNum(r.xg_total, 2) },
                  { k: "U2.5", v: fmtPct(r.p_under_2_5) },
                  { k: "O2.5", v: fmtPct(r.p_over_2_5) },
                  { k: "Suggested", v: suggested },
                ]
              ]
            });
            return;
          }

          const b = sig.signal_breakdown || {};
          const mkP = sig.p_market_under_fair;
          const dlt = sig.delta_model_vs_market;

          openDrawer({
            title: `${sig.home} vs ${sig.away}`,
            sub: `${fmtDate(sig.utc_date)} • Fixture ${sig.fixture_id}`,
            blocks: [
              [
                { k: "Signal Score", v: String(sig.signal_score ?? "—") },
                { k: "Tier", v: tierFromScore(sig.signal_score).t },
                { k: "Suggested", v: sig.suggested ?? suggested },
                { k: "Odds (Under)", v: sig.market_under_odds ? fmtNum(sig.market_under_odds, 2) : "—" },
              ],
              [
                { k: "xG home", v: sig.xg_home !== undefined ? fmtNum(sig.xg_home, 2) : "—" },
                { k: "xG away", v: sig.xg_away !== undefined ? fmtNum(sig.xg_away, 2) : "—" },
                { k: "xG total", v: sig.xg_total !== undefined ? fmtNum(sig.xg_total, 2) : fmtNum(r.xg_total, 2) },
                { k: "U2.5 (model)", v: sig.p_under_2_5 !== undefined ? fmtPct(sig.p_under_2_5) : fmtPct(r.p_under_2_5) },
              ],
              [
                { k: "Market P(U2.5) fair", v: (mkP === null || mkP === undefined) ? "—" : fmtPct(mkP) },
                { k: "Δ model vs market", v: (dlt === null || dlt === undefined) ? "—" : fmtNum(dlt, 3) },
                { k: "Cal bucket", v: sig.calibration_bucket ?? sig.cal_bucket ?? "—" },
                { k: "Cal observed", v: (sig.calibration_observed === null || sig.cal_observed === null || sig.calibration_observed === undefined || sig.cal_observed === undefined) ? "—" : fmtPct(sig.calibration_observed ?? sig.cal_observed) },
              ],
              [
                { k: "Breakdown: disagreement", v: (b.market_disagreement ?? "—").toString() },
                { k: "Breakdown: xG bias", v: (b.xg_bias ?? "—").toString() },
                { k: "Breakdown: calibration", v: (b.calibration ?? "—").toString() },
                { k: "Breakdown: volatility", v: (b.volatility_penalty ?? "—").toString() },
              ],
            ]
          });
        });

        totalsTableBody.appendChild(tr);
      }
    }

    async function load() {
      clearTables();
      elStatus.textContent = "Loading…";

      try {
        const picksP = fetchJson(PICKS_URL).catch(() => []);
        const totalsP = fetchJson(TOTALS_URL).catch(() => []);
        const signalP = fetchJson(SIGNAL_URL).catch(() => []);

        const [picks, totals, signals] = await Promise.all([picksP, totalsP, signalP]);

        renderPicks(Array.isArray(picks) ? picks : []);

        const signalIndex = Array.isArray(signals) ? buildSignalIndex(signals) : new Map();
        renderTotals(Array.isArray(totals) ? totals : [], signalIndex);

        const now = new Date();
        elStatus.textContent = `Updated ${now.toLocaleString()} • Sources: ${PICKS_URL}, ${TOTALS_URL}, ${SIGNAL_URL}`;
      } catch (err) {
        console.error(err);
        elStatus.textContent = "Failed to load data. Check console.";
        picksCount.textContent = "0";
        totalsCount.textContent = "0";
        picksMeta.textContent = "";
        totalsMeta.textContent = "";

        const card1 = document.querySelectorAll(".card")[0];
        const div = document.createElement("div");
        div.className = "err";
        div.textContent = String(err);
        card1.appendChild(div);
      }
    }

    refreshBtn.addEventListener("click", load);
    load();
  </script>
</body>
</html>
